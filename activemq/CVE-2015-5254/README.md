# ActiveMQ Unsafe Deserialization Vulnerability（CVE-2015-5254）

Apache ActiveMQ is an open source messaging middleware developed by the Apache Software Foundation. It supports Java messaging services, clustering, and Spring Framework.

Apache ActiveMQ 5.x before 5.13.0 does not restrict the classes that can be serialized in the broker, which allows remote attackers to execute arbitrary code via a crafted serialized Java Message Service (JMS) ObjectMessage object.

Reference link:

- https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf

## Vulnerable environment

Start the vulnerable environment:

```
docker-compose up -d
```

After the environment is started, it will listen on both ports 61616 and 8161. Port 61616 is the vulnerable port we will later send a message to. Port 8161 is the web management page port. You can access the web management page by visiting `http://your-ip:8161`.

## Exploit

The exploit process is as follows:

1. Generate payload (can use ysoserial)
2. As a message, send to port 61616
3. Access the web management page and read the queued message, access it to trigger the payload

To exploit this environment we will use [jmet](https://github.com/matthiaskaiser/jmet) Java Message Exploitation Tool.

First download the jar file of jmet, and create folder called `external` in the same directory (otherwise it may display an error that the folder does not exist).

We then use ysoserial to generate a payload and send it (the jmet jar comes with ysoserial, no need to download it separately). We need to choose one that can be used in ysoserial as a gadget, such as ROME.

Example:

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "touch /tmp/success" -Yp ROME your-ip 61616
```

![](1.png)

At this point, a new event will be added to the target ActiveMQ queue. We can visit `http://your-ip:8161/admin/browse.jsp?JMSDestination=event` to see all the messages in this queue：

![](2.png)

By clicking on this message we trigger the command execution. Next we enter the container and run `docker-compose exec activemq bash`. It can be seen that /tmp/success has been successfully created, indicating that the exploit is successful:

![](3.png)

We can replace the command within the shell statement and reuse it:

![](4.png)

It's worth noting that accessing messages through the web administration page and triggering the vulnerability requires administrator privileges. In the absence of a password, we can attempt to social engineer the administrator into clicking our queued event link.
